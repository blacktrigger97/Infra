version: '3.8'

networks:
  bdCluster:
    name: bdCluster
    driver: ipvlan
    external: true
    driver_opts:
      parent: ${ETHERNET_NAME}
    ipam:
      config:
        - subnet: 192.168.1.0/24
          gateway: 192.168.1.1

services:

  postgresql:
    image: postgres:${DB_VER}
    container_name: postgresql
    hostname: postgresql.bdc.home
    cpus: 1
    restart: unless-stopped
    networks:
      bdCluster:
        ipv4_address: 192.168.1.43
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=${DOCKER_PASS}
    ports:
      - 5432:5432
    volumes: 
      - ./postgresql/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ${LOCAL_DIR}${DB_DIR}:/var/lib/postgresql/data

  nessie:
    build:
      context: nessie
      dockerfile: ${HOST_DIR}/ext_serv/nessie/Dockerfile
      args:
        - DOCKER_USR=${DOCKER_USR}
        - DOCKER_PASS=${DOCKER_PASS}
        - NESSIE_VER=${NESSIE_VER}
    image: nessie
    container_name: nessie
    hostname: nessie.bdc.home
    restart: unless-stopped
    networks:
      bdCluster:
        ipv4_address: 192.168.1.44
    ports:
      - 19120:19120
    depends_on:
      - postgresql 

  trino-co:
    image: "trinodb/trino:445"
    hostname: trino-co.bdc.home
    container_name: trino-co
    networks:
      bdCluster:
        ipv4_address: 192.168.1.30
    ports:
      - "8080:8080"
    volumes:
      - ./trino/trino-co/etc:/etc/trino
      - ./trino/trino-co/catalog:/etc/trino/catalog
      - /root/docker/hdc_data/trino/data:/data/trino
    depends_on:
      - nessie

  trino-wk1:
    image: "trinodb/trino:445"
    hostname: trino-wk1.bdc.home
    container_name: trino-wk1
    networks:
      bdCluster:
        ipv4_address: 192.168.1.31
    ports:
      - "8081:8081"
    volumes:
      - ./trino/trino-wk/etc:/etc/trino
      - ./trino/trino-wk/catalog:/etc/trino/catalog
      - /root/docker/hdc_data/trino/data:/data/trino

  zookeeper-1:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_SERVERS: zookeeper-1:2888:3888;zookeeper-2:2888:3888
    hostname: zookeeper-1.bdc.home
    container_name: zookeeper-1
    networks:
      bdCluster:
        ipv4_address: 192.168.1.60
    ports:
      - 22181:2181

  zookeeper-2:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SERVER_ID: 2
      ZOOKEEPER_SERVERS: zookeeper-1:2888:3888;zookeeper-2:2888:3888
    hostname: zookeeper-2.bdc.home
    container_name: zookeeper-2
    networks:
      bdCluster:
        ipv4_address: 192.168.1.61
    ports:
      - 32181:2181
  
  kafka-1:
    image: confluentinc/cp-kafka:latest
    hostname: kafka-1.bdc.home
    container_name: kafka-1
    networks:
      bdCluster:
        ipv4_address: 192.168.1.70
    ports:
      - 29092:29092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-1.bdc.home:2181,zookeeper-2.bdc.home:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1.bdc.home:9092,PLAINTEXT_HOST://kafka-1.bdc.home:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper-1

  kafka-2:
    image: confluentinc/cp-kafka:latest
    hostname: kafka-2.bdc.home
    container_name: kafka-2
    networks:
      bdCluster:
        ipv4_address: 192.168.1.71
    ports:
      - 39092:39092
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-1.bdc.home:2181,zookeeper-2.bdc.home:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-2.bdc.home:9092,PLAINTEXT_HOST://kafka-2.bdc.home:39092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper-2

  hue:
    image: gethue/hue:latest
    hostname: hue.bdc.home
    container_name: hue
    networks:
      bdCluster:
        ipv4_address: 192.168.1.46
    ports:
      - 8888:8888
    volumes:
      - ./hue/hue.ini:/usr/share/hue/desktop/conf/z-hue.ini
    depends_on: 
      - trino-co
      
  #kafka-schema-registry:
  #  image: confluentinc/cp-schema-registry:latest
  #  hostname: kafka-schema-registry
  #  container_name: kafka-schema-registry
  #  depends_on:
  #    - zoo1
  #    - zoo2
  #    - zoo3
  #    - kafka1
  #    - kafka2
  #    - kafka3
  #  ports:
  #    - "8081:8081"
  #  environment:
  #    SCHEMA_REGISTRY_HOST_NAME: kafka-schema-registry
  #    SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: 'PLAINTEXT://kafka1:19092,PLAINTEXT://kafka2:19093'
  #    SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
  